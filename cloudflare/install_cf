#!/bin/bash

## First install the CF files
cp Cpanel/CloudFlare.pm /usr/local/cpanel/Cpanel

## Now the JS
cp -r base/frontend/default/js2/cloudflare /usr/local/cpanel/base/frontend/default/js2/

## And the HTML files
cp -r base/frontend/default/cloudflare /usr/local/cpanel/base/frontend/default/

## Update Net/SSLeay.pm so that cpanel will work.
cp /usr/local/cpanel/perl/Net/SSLeay.pm /usr/local/cpanel/perl/Net/SSLeay.pm.backup
sed -i -e '62,1d' /usr/local/cpanel/perl/Net/SSLeay.pm

## Lastly register the plugin with Cpanel
/usr/local/cpanel/bin/register_cpanelplugin cloudflare.cpanelplugin

## And write the config file
cp etc/cloudflare.json /usr/local/cpanel/etc/

## Also data file -- world readible, for the web server.
## @TODO -- figure out what user this users.
touch /usr/local/cpanel/etc/cloudflare_data.yaml
chmod 666 /usr/local/cpanel/etc/cloudflare_data.yaml

echo "

CloudFlare module installed successfully.
==> You must now edit /usr/local/cpanel/etc/cloudflare.json and add your CloudFlare host API key before continuing."