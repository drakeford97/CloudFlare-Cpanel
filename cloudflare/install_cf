#!/bin/bash

DEFAULT_HOST_KEY="DEFAULT_KEY_REPLACE_ME"
host_key=$1
if [ "$host_key" == "" ]; then
    echo "Usage: ./install_cf HOST_KEY."
    echo ""
    echo "If you do not have a HOST_KEY, contact CloudFlare for one before proceeding."
    exit 0
fi

## First install the CF files
cp Cpanel/CloudFlare.pm /usr/local/cpanel/Cpanel

## Now the JS
cp -r base/frontend/default/js2/cloudflare /usr/local/cpanel/base/frontend/default/js2/

## And the HTML files
cp -r base/frontend/default/cloudflare /usr/local/cpanel/base/frontend/default/

## Update Net/SSLeay.pm so that cpanel will work.
line62=`sed 62q /usr/local/cpanel/perl/Net/SSLeay.pm | tail -1`

if [[ "$line62" =~ 'use 5.' ]]; then
    cp /usr/local/cpanel/perl/Net/SSLeay.pm /usr/local/cpanel/perl/Net/SSLeay.pm.backup
    sed -i -e '62,1d' /usr/local/cpanel/perl/Net/SSLeay.pm
fi

## Lastly register the plugin with Cpanel
/usr/local/cpanel/bin/register_cpanelplugin cloudflare.cpanelplugin

## Updating to swap out the default key for an actual one.
cp etc/cloudflare.json.back etc/cloudflare.json
sed -i -e "s/$DEFAULT_HOST_KEY/$host_key/" etc/cloudflare.json 

## And write the config file
cp etc/cloudflare.json /usr/local/cpanel/etc/

## Also data file -- world readible, for the web server.
## @TODO -- figure out what user this users.
touch /usr/local/cpanel/etc/cloudflare_data.yaml
chmod 666 /usr/local/cpanel/etc/cloudflare_data.yaml

echo "

CloudFlare module installed successfully.
==> You must now edit /usr/local/cpanel/etc/cloudflare.json and add your CloudFlare host API key before continuing."